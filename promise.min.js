/**
 * Module Promise
 *
 * Copyright (c) 2016 Nikita Stenin (stenin.nikita@gmail.com)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * @version 0.1.2
 */(function(e,t,n){var r=e.__namespace__||"Core";if(typeof define=="function"&&define.amd)define(r+"."+t,[],function(){return n(e)});else if(typeof module=="object"&&module.exports)module.exports=n(e);else if(typeof modules=="object"&&typeof modules.define=="function")modules.define(r+"."+t,[],function(t){t(n(e))});else{var i,s;e[r]=e[r]||{},s=e[r],i=t.split(".");while(i.length>1)t=i.shift(),s[t]=s[t]||{},s=s[t];s[i.shift()]=n(e)}})(this,"Promise",function(e){"use strict";var t=0,n=-1,r=1,i=function(){function n(e){return t.push(e)===1}function r(){var e=t,n=0,r=t.length;t=[];while(n<r)e[n++]()}var t=[];if(typeof setImmediate=="function")return function(e){n(e)&&setImmediate(r)};if(typeof process=="object"&&process.nextTick)return function(e){n(e)&&process.nextTick(r)};var i=e.MutationObserver||e.WebKitMutationObserver;if(i){var s=1,o=document.createTextNode("");return(new i(r)).observe(o,{characterData:!0}),function(e){n(e)&&(o.data=s*=-1)}}if(e.postMessage){var u=!0;if(e.attachEvent){function a(){u=!1}e.attachEvent("onmessage",a),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",a)}if(u){var f="__promise"+Math.random()+"_"+new Date;function l(e){e.data===f&&(e.stopPropagation&&e.stopPropagation(),r())}return e.addEventListener?e.addEventListener("message",l,!0):e.attachEvent("onmessage",l),function(t){n(t)&&e.postMessage(f,"*")}}}var c=e.document;if("onreadystatechange"in c.createElement("script")){function h(){var e=c.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,r()},(c.documentElement||c.body).appendChild(e)}return function(e){n(e)&&h()}}return function(e){n(e)&&setTimeout(r,0)}}(),s=function(e){return a(e)&&u(e.then)},o=function(e){return e!==null&&typeof e=="object"},u=function(e){return typeof e=="function"},a=function(e){return e!==null&&typeof e=="object"||typeof e=="function"},f=function(e,t,n,r){return function(i){t[e]=i,--n&&r.resolve(t)}},l=function(e){function n(n){if(t)return;t=!0,e._resolve(n)}function r(n){if(t)return;t=!0,e._reject(n)}function i(n){if(t)return;e._notify(n)}var t=!1;return{resolve:n,reject:r,notify:i}},c=function(e){var t=l(e);return t.promise=e,t},h=function(e,t){try{e(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}},p=function(e,n,r,i){try{i=e.handler.call(void 0,n),t!==r?e.deferred.resolve(i):e.deferred.notify(i)}catch(s){try{e.deferred.reject(s)}catch(o){}}},d=function(e,t){try{var n=e.then}catch(r){return t._reject(r),!1}return n},v=function(e,t,n){try{e.call(t,n.resolve,n.reject,n.notify)}catch(r){n.reject(r)}},m=function(n){if(this===void 0)throw new TypeError("undefined is not a promise");if(!u(n))throw new TypeError("Promise resolver "+String(n)+" is not a function");this._value=void 0,this._status=t,this._onResolve=[],this._onReject=[],this._onProgress=[];if(n===c)return n(this);var r=l(this);h(n,r)};return m.prototype={constructor:m,then:function(e,i,s){if(this._status===void 0)throw new TypeError(String(this)+" is not a promise");e=u(e)?e:function(e){return e},i=u(i)?i:function(e){throw e},s=u(s)?s:function(e){return e};var o=new m(c),a;return this._status!==n&&(a={handler:e,deferred:o},this._status===r?this._enqueue(this._value,[a]):this._onResolve.push(a)),this._status!==r&&(a={handler:i,deferred:o},this._status===n?this._enqueue(this._value,[a]):this._onReject.push(a)),this._status===t&&this._onProgress.push({handler:s,deferred:o}),o.promise},chain:function(e,t,n){return this.then(e,t,n)},"catch":function(e){return this.then(void 0,e)},_resolve:function(e){if(e===this){this._reject(new TypeError("Chaining cycle detected for promise "+String(e)));return}var t,n;if(a(e)){t=d(e,this);if(t===!1)return;if(u(t)){n=l(this),v(t,e,n);return}}this._done(r,e,this._onResolve)},_reject:function(e){s(e)?(e=e.then(function(e){var t=new m(c);return t.reject(e),t.promise}),this._resolve(e)):this._done(n,e,this._onReject)},_notify:function(e){this._onProgress.length&&this._enqueue(e,this._onProgress)},_done:function(e,n,r){this._status===t&&(r.length&&this._enqueue(n,r),this._status=e,this._value=n,this._onResolve=this._onReject=this._onProgress=void 0)},_enqueue:function(e,t){var n=t.length,r=this,s=0;i(function(){while(s<n)p(t[s],e,r._status),s+=1})},progress:function(e){return this.then(void 0,void 0,e)},fail:function(e){return this.then(void 0,e)},done:function(e,t,n){this.then(e,t,n).fail(function(e){i(function(){throw e})})},always:function(e){var t=this,n=function(){return e.call(this,t)};return this.then(n,n)},spread:function(e,t,n){return this.then(function(t){return e.apply(this,t)},t,n)},delay:function(e){var t,n,r=this,i=this.then(function(r){return n=new m(c),t=setTimeout(function(){n.resolve(r)},e),n.promise});return i.always(function(){clearTimeout(t)}),i},timeout:function(e){var t=new m(c),n=setTimeout(function(){t.reject(new Error("timed out"))},e);return this.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise.always(function(){clearTimeout(n)}),t.promise}},m.all=function(e){if(!a(this))throw new TypeError("Promise.all called on non-object");var t=new m(c),n=e.length,r=[],i=n,s=0;if(!n)return t.resolve(r),t.promise;while(s<n)m.resolve(e[s]).then(f(s,r,i,t),t.reject,t.notify),s+=1;return t.promise},m.defer=function(){return new m(c)},m.race=function(e){if(!a(this))throw new TypeError(String(this)+" called on non-object");var t,n=0,r=e.length,i=new m(c);try{while(n<r)t=e[n],this.resolve(t).then(i.resolve,i.reject,i.notify),n+=1}catch(s){i.reject(s)}return i.promise},m.resolve=function(e){if(!a(this))throw new TypeError(String(this)+" called on non-object");if(s(e)&&e.constructor===this)return e;var t=new m(c);return t.resolve(e),t.promise},m.reject=function(e){if(!a(this))throw new TypeError(String(this)+" called on non-object");var t=new m(c);return t.reject(e),t.promise},m.accept=function(e){return this.resolve(e)},m.fulfill=function(e){var t=new m(c),n=t.promise;return t.resolve(e),n._status===r?n:n.then(null,function(e){return e})},m.when=function(e,t,n,r){return this.resolve(e).then(t,n,r)},m.fail=function(e,t){return this.resolve(e).then(void 0,t)},m.always=function(e,t){return this.resolve(e).always(t)},m.spread=function(e,t,n,r){return this.resolve(e).spread(t,n,r)},m.done=function(e,t,n,r){return this.resolve(e).done(t,n,r)},m.delay=function(e,t){return this.resolve(e).delay(t)},m.timeout=function(e,t){return this.resolve(e).timeout(t)},m.progress=function(e,t){return this.resolve(e).progress(t)},m});