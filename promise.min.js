/**
 * Module Promise
 *
 * Copyright (c) 2016 Nikita Stenin (stenin.nikita@gmail.com)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * @version 0.1.0
 */(function(e,t,n){var r=e.__namespace__||"Core";if(typeof define=="function"&&define.amd)define(r+"."+t,[],function(){return n(e)});else if(typeof module=="object"&&module.exports)module.exports=n(e);else if(typeof modules=="object"&&typeof modules.define=="function")modules.define(r+"."+t,[],function(t){t(n(e))});else{var i,s;e[r]=e[r]||{},s=e[r],i=t.split(".");while(i.length>1)t=i.shift(),s[t]=s[t]||{},s=s[t];s[i.shift()]=n(e)}})(this,"Promise",function(e){"use strict";var t=function(e){return i(e)&&r(e.then)},n=function(e){return e!==null&&typeof e=="object"},r=function(e){return typeof e=="function"},i=function(e){return n(e)||r(e)},s=function(e,t,n,r){return function(i){t[e]=i,--n&&r.resolve(t)}},o=function(e){var n=!1,r=function(t){if(n)return;n=!0,e._resolve(t)},i=function(r){if(n)return;n=!0,t(r)?(r=r.then(function(e){var t=new l(u);return t.reject(e),t.promise}),e._resolve(r)):e._reject(r)},s=function(t){if(n)return;e._notify(t)};return{resolve:r,reject:i,notify:s}},u=function(e){var t=o(e);return t.promise=e,t},a=function(){var t=[],n=function(e){return t.push(e)===1},r=function(){var e=t,n=0,r=t.length;t=[];while(n<r)e[n++]()};if(typeof setImmediate=="function")return function(e){n(e)&&setImmediate(r)};if(typeof process=="object"&&process.nextTick)return function(e){n(e)&&process.nextTick(r)};var i=e.MutationObserver||e.WebKitMutationObserver;if(i){var s=1,o=document.createTextNode("");return(new i(r)).observe(o,{characterData:!0}),function(e){n(e)&&(o.data=s*=-1)}}if(e.postMessage){var u=!0;if(e.attachEvent){var a=function(){u=!1};e.attachEvent("onmessage",a),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",a)}if(u){var f="__promise"+Math.random()+"_"+new Date,l=function(e){e.data===f&&(e.stopPropagation&&e.stopPropagation(),r())};return e.addEventListener?e.addEventListener("message",l,!0):e.attachEvent("onmessage",l),function(t){n(t)&&e.postMessage(f,"*")}}}var c=e.document;if("onreadystatechange"in c.createElement("script")){var h=function(){var e=c.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,r()},(c.documentElement||c.body).appendChild(e)};return function(e){n(e)&&h()}}return function(e){n(e)&&setTimeout(r,0)}}(),f={PENDING:0,REJECTED:-1,RESOLVED:1},l=function(t){if(this===void 0)throw new TypeError("undefined is not a promise");if(!r(t))throw new TypeError("Promise resolver "+String(t)+" is not a function");this._value=void 0,this._status=f.PENDING,this._onResolve=[],this._onReject=[],this._onProgress=[];if(t===u)return u(this);var n=o(this);try{t(n.resolve,n.reject,n.notify)}catch(i){n.reject(i)}};return l.prototype={constructor:l,then:function(e,t,n){if(this._status===void 0)throw new TypeError(String(this)+" is not a promise");e=r(e)?e:function(e){return e},t=r(t)?t:function(e){throw e},n=r(n)?n:function(e){return e};var i=new l(u),s;return this._status!==f.REJECTED&&(s={handler:e,deferred:i},this._status==f.RESOLVED?this._enqueue(this._value,[s]):this._onResolve.push(s)),this._status!==f.RESOLVED&&(s={handler:t,deferred:i},this._status==f.REJECTED?this._enqueue(this._value,[s]):this._onReject.push(s)),this._status===f.PENDING&&this._onProgress.push({handler:n,deferred:i}),i.promise},chain:function(e,t,n){return this.then(e,t,n)},"catch":function(e){return this.then(void 0,e)},_resolve:function(e){if(e===this){this._reject(new TypeError("Chaining cycle detected for promise "+String(e)));return}var t,n;if(i(e)){try{t=e.then}catch(s){this._reject(s);return}if(r(t)){n=o(this);try{t.call(e,n.resolve,n.reject,n.notify)}catch(s){n.reject(s)}return}}this._done(f.RESOLVED,e,"_onResolve")},_reject:function(e){this._done(f.REJECTED,e,"_onReject")},_notify:function(e){this._onProgress.length&&this._enqueue(e,this._onProgress)},_done:function(e,t,n){if(this._status===f.PENDING){var r=this[n];r.length&&this._enqueue(t,r),this._status=e,this._value=t,this._onResolve=this._onReject=this._onProgress=void 0}},_enqueue:function(e,t){var n=t.length,r=this,i=0;a(function(){while(i<n)r._handle(t[i],e),i+=1})},_handle:function(e,t){var n;try{n=e.handler.call(void 0,t),f.PENDING!==this._status?e.deferred.resolve(n):e.deferred.notify(n)}catch(r){try{e.deferred.reject(r)}catch(i){}}},progress:function(e){return this.then(void 0,void 0,e)},fail:function(e){return this.then(void 0,e)},done:function(e,t,n){this.then(e,t,n).fail(function(e){a(function(){throw e})})},always:function(e){var t=this,n=function(){return e.call(this,t)};return this.then(n,n)},spread:function(e,t,n){return this.then(function(t){return e.apply(this,t)},t,n)},delay:function(e){var t,n,r=this,i=this.then(function(r){return n=new l(u),t=setTimeout(function(){n.resolve(r)},e),n.promise});return i.always(function(){clearTimeout(t)}),i},timeout:function(e){var t=new l(u),n=setTimeout(function(){t.reject(new Error("timed out"))},e);return this.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise.always(function(){clearTimeout(n)}),t.promise}},l.all=function(e){if(!i(this))throw new TypeError("Promise.all called on non-object");var t=new l(u),n=e.length,r=[],o=r.length,a=0;if(!n)return t.resolve(r),t.promise;while(a<n)l.resolve(e[a]).then(s(a,r,o,t),t.reject,t.notify),++a;return t.promise},l.defer=function(){return new l(u)},l.race=function(e){if(!i(this))throw new TypeError(String(this)+" called on non-object");var t,n=new l(u);try{for(var r=0;r<e.length;r++)t=e[r],this.resolve(t).then(n.resolve,n.reject,n.notify)}catch(s){n.reject(s)}return n.promise},l.resolve=function(e){if(!i(this))throw new TypeError(String(this)+" called on non-object");if(t(e)&&e.constructor===this)return e;var n=new l(u);return n.resolve(e),n.promise},l.reject=function(e){if(!i(this))throw new TypeError(String(this)+" called on non-object");var t=new l(u);return t.reject(e),t.promise},l.accept=function(e){return this.resolve(e)},l.fulfill=function(e){var t=new l(u),n=t.promise;return t.resolve(e),n._status===f.RESOLVED?n:n.then(null,function(e){return e})},l.when=function(e,t,n,r){return this.resolve(e).then(t,n,r)},l.fail=function(e,t){return this.resolve(e).then(void 0,t)},l.always=function(e,t){return this.resolve(e).always(t)},l.spread=function(e,t,n,r){return this.resolve(e).spread(t,n,r)},l.done=function(e,t,n,r){return this.resolve(e).done(t,n,r)},l.delay=function(e,t){return this.resolve(e).delay(t)},l.timeout=function(e,t){return this.resolve(e).timeout(t)},l.progress=function(e,t){return this.resolve(e).progress(t)},l});
